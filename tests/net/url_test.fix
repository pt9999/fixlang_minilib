module Main;

import Debug;

import URL;
import StringEx;
import UnitTest;

test_URL_parse_ok: (String, (String, String, String, String)) -> TestCase;
test_URL_parse_ok = |(str, (scheme, host, port, path))| (
    let testname = "test_URL_parse_ok (" + str + ")";
    make_test(testname) $ |_|
    let expected = URL {
        url: str,
        scheme: scheme,
        host: host,
        port: port,
        path: path
    };
    let actual = *URL::parse(str).from_result;
    let _ = *(assert_equal("eq", expected, actual));
    pure()
);

test_URL_parse_ng: (String, ErrMsg) -> TestCase;
test_URL_parse_ng = |(str, expected)| (
    let testname = "test_URL_parse_ng (" + str + ")";
    make_test(testname) $ |_|
    let res = URL::parse(str);
    let _ = *(assert_true("err", res.is_err));
    let _ = *(assert_equal("eq", expected, res.as_err));
    pure()
);

test_URL_parse: TestCase;
test_URL_parse = (
    [
        test_URL_parse_ok $ ("http://example.com/aaa/bbb", ("http", "example.com", "80", "/aaa/bbb")),
        test_URL_parse_ok $ ("https://example.com/", ("https", "example.com", "443", "/")),
        test_URL_parse_ok $ ("localhost:8080", ("http", "localhost", "8080", "/")),
        test_URL_parse_ok $ ("127.0.0.1", ("http", "127.0.0.1", "80", "/")),
        test_URL_parse_ng $ ("", "Invalid host"),
        test_URL_parse_ng $ ("example.com:abc", "Invalid port"),
        TestCase::empty
    ].run_tests
);

test_encodeURIComponent_ok: (String, String) -> TestCase;
test_encodeURIComponent_ok = |(str, expected)| (
    let testname = "test_encodeURIComponent_ok (" + expected + ")";
    make_test(testname) $ |_|
    let actual = encodeURIComponent(str);
    let _ = *(assert_equal("eq", expected, actual));
    pure()
);

test_encodeURIComponent: TestCase;
test_encodeURIComponent = (
    [
        test_encodeURIComponent_ok $ ("", ""),
        test_encodeURIComponent_ok $ ("09AZaz-._~", "09AZaz-._~"),
        test_encodeURIComponent_ok $ ("/:@[`{", "%2F%3A%40%5B%60%7B"), // edge case of 0-9, A-Z, a-z
        test_encodeURIComponent_ok $ ([1_U8, 31_U8, 32_U8, 127_U8, 128_U8, 255_U8]._unsafe_to_string, "%01%1F%20%7F%80%FF"),
        TestCase::empty
    ].run_tests
);

test_decodeURIComponent_ok: (String, String) -> TestCase;
test_decodeURIComponent_ok = |(str, expected)| (
    let testname = "test_decodeURIComponent_ok (" + str + ")";
    make_test(testname) $ |_|
    let res = decodeURIComponent(str);
    let _ = *(assert_true("ok", res.is_ok));
    let _ = *(assert_equal("eq", expected, res.as_ok));
    pure()
);

test_decodeURIComponent_ng: (String, ErrMsg) -> TestCase;
test_decodeURIComponent_ng = |(str, expected)| (
    let testname = "test_decodeURIComponent_ng (" + str + ")";
    make_test(testname) $ |_|
    let res = decodeURIComponent(str);
    let _ = *(assert_true("err", res.is_err));
    let _ = *(assert_equal("eq", expected, res.as_err));
    pure()
);

test_decodeURIComponent: TestCase;
test_decodeURIComponent = (
    [
        test_decodeURIComponent_ok $ ("", ""),
        test_decodeURIComponent_ok $ ("09AZaz-._~", "09AZaz-._~"),
        test_decodeURIComponent_ok $ ("%2F%3A%40%5B%60%7B", "/:@[`{"), // edge case of 0-9, A-Z, a-z
        test_decodeURIComponent_ok $ ("%01%1F%20%7F%80%FF", [1_U8, 31_U8, 32_U8, 127_U8, 128_U8, 255_U8]._unsafe_to_string),
        test_decodeURIComponent_ng $ ("%", "Percent sign requires two characters"),
        test_decodeURIComponent_ng $ ("%0", "Percent sign requires two characters"),
        test_decodeURIComponent_ng $ ("%0X", "Not a hexadecimal character: 'X'"),
        TestCase::empty
    ].run_tests
);

main: IO ();
main = (
    [
        test_URL_parse,
        test_encodeURIComponent,
        test_decodeURIComponent,
        TestCase::empty
    ]
    .run_test_driver
);
