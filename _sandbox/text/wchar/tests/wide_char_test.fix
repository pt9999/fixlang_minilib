module WideCharTest;

import Minilib.Text.Locale;
import Minilib.Text.WideChar;
import Minilib.Text.Unicode;
import Minilib.Text.StringEx;
import Minilib.Testing.UnitTest;
import Minilib.Trait.Traversable;

make_wctype_test: String -> (WideChar -> Bool) -> String -> String -> TestCase;
make_wctype_test = |testname, is_type, true_chars, false_chars| (
    make_test(testname, |_|
        let test = |chars, expected| (
            let wchars = chars.to_utf32_string;
            range(0, wchars.get_size).foreach_m(|i|
                let wc = wchars.@(i);
                let s = wchars.get_sub(i, i+1).to_string;
                let actual = is_type(wc);
                //println((testname, s, actual).format("{}: {} -> {}")).lift;;
                assert_equal(testname + ":`" + s + "`", expected, actual)
            )
        );
        test(true_chars, true);;
        test(false_chars, false)
    )
);

test_is_alpha: TestCase;
test_is_alpha = make_wctype_test(
    "test_is_alpha", WideChar::is_alpha,
    "AZazÏ‰Î©ï¼¡ï¼ºï½ï½šã‚æ¼¢ï¼ï¼™",             // "ï¼ï¼™" are alphabets
    "09!#ï½ï¼ï¼Ÿã€‚ã€"
);

test_is_alnum: TestCase;
test_is_alnum = make_wctype_test(
    "test_is_alnum", WideChar::is_alnum,
    "09AZazÏ‰Î©ï¼¡ï¼ºï½ï½šã‚æ¼¢ï¼ï¼™",
    "!#ï½ï¼ï¼Ÿã€‚ã€"
);

test_is_blank: TestCase;
test_is_blank = make_wctype_test(
    "test_is_blank", WideChar::is_blank,
    " \tã€€",
    "\u000c\n\r\u000b!#ï½ï¼ï¼Ÿã€‚ã€09aAÏ‰Î©ã‚æ¼¢ï¼ï¼™"
);

test_is_cntrl: TestCase;
test_is_cntrl = make_wctype_test(
    "test_is_cntrl", WideChar::is_cntrl,
    "\t\u000c\n\r\u000b",
    " ã€€!#ï½ï¼ï¼Ÿã€‚ã€09aAÏ‰Î©ã‚æ¼¢ï¼ï¼™"
);

test_is_digit: TestCase;
test_is_digit = make_wctype_test(
    "test_is_digit", WideChar::is_digit,
    "09",
    " \t\u000c\n\r\u000bã€€!#ï½ï¼ï¼Ÿã€‚ã€aAÏ‰Î©ã‚æ¼¢ï¼ï¼™â‘ â¾"      // "ï¼ï¼™" are not digits
);

test_is_graph: TestCase;
test_is_graph = make_wctype_test(
    "test_is_graph", WideChar::is_graph,
    "09!#ï½ï¼ï¼Ÿã€‚ã€aAÏ‰Î©ã‚æ¼¢ï¼ï¼™â‘ â¾",
    " \t\u000c\n\r\u000bã€€"
);

test_is_lower: TestCase;
test_is_lower = make_wctype_test(
    "test_is_lower", WideChar::is_lower,
    "aÏ‰ï½ï½š",
    " \t\u000c\n\r\u000bã€€09!#ï½ï¼ï¼Ÿã€‚ã€AÎ©ã‚æ¼¢ï¼ï¼™ï¼¡ï¼ºâ‘ â¾"
);

test_is_print: TestCase;
test_is_print = make_wctype_test(
    "test_is_print", WideChar::is_print,
    " !#ï½ï¼ï¼Ÿã€‚ã€ã€€09aAÏ‰Î©ã‚æ¼¢ï¼ï¼™â‘ â¾",
    "\t\u000c\n\r\u000b"
);

test_is_punct: TestCase;
test_is_punct = make_wctype_test(
    "test_is_punct", WideChar::is_punct,
    "!#ï½ï¼ï¼Ÿã€‚ã€â‘ â¾",      // "â‘ â¾" are punctuations
    " \t\u000c\n\r\u000bã€€09aAÏ‰Î©ã‚æ¼¢ï¼ï¼™"
);

test_is_space: TestCase;
test_is_space = make_wctype_test(
    "test_is_space", WideChar::is_space,
    " \t\u000c\n\r\u000bã€€",
    "!#ï½ï¼ï¼Ÿã€‚ã€09aAÏ‰Î©ã‚æ¼¢ï¼ï¼™"
);

test_is_upper: TestCase;
test_is_upper = make_wctype_test(
    "test_is_upper", WideChar::is_upper,
    "AÎ©ï¼¡ï¼º",
    " \t\u000c\n\r\u000bã€€09!#ï½ï¼ï¼Ÿã€‚ã€aÏ‰ã‚æ¼¢ï¼ï¼™ï½ï½šâ‘ â¾"
);

test_is_xdigit: TestCase;
test_is_xdigit = make_wctype_test(
    "test_is_xdigit", WideChar::is_xdigit,
    "09Aa",
    " \t\u000c\n\r\u000bã€€!#ï½ï¼ï¼Ÿã€‚ã€Ï‰Î©ã‚æ¼¢ï¼ï¼™ï¼¡ï¼¦ï¼ºâ‘ â¾"    // "ï¼ï¼™ï¼¡ï¼¦" are not xdigits
);

test_wcwidth: TestCase;
test_wcwidth = make_table_test("test_wcwidth",
    [
        (" ", 1),
        ("\t", -1),     // '\t' is nonprintable
        ("0", 1),
        ("A", 1),
        ("ã‚", 2),
        ("æ¼¢", 2),
        ("ï¼", 2),
        ("ï¼¡", 2),
    ],
    |(str, expected)|
    let wstr = str.to_utf32_string;
    let wc = wstr.@(0);
    let actual = wcwidth(wc);
    assert_equal("wcwidth(" + str + ")", expected, actual)
);

test_wcswidth: TestCase;
test_wcswidth = make_table_test("test_wcswidth",
    [
        ("", 0),
        (" \t09AZaz!#", -1),        // '\t' is nonprintable
        ("  09AZaz!#", 10),
        ("ã‚æ¼¢ï¼ï¼¡ğŸ˜ŠğŸ˜€", 12),
        ("  09AZaz!#ã‚æ¼¢ï¼ï¼¡ğŸ˜ŠğŸ˜€", 22),
    ],
    |(str, expected)|
    let wstr = str.to_utf32_string;
    let actual = wcswidth(wstr.@data);
    assert_equal("wcswidth(" + str + ")", expected, actual)
);

main: IO ();
main = (
    init_locale;;
    [
        test_is_alpha,
        test_is_alnum,
        test_is_blank,
        test_is_cntrl,
        test_is_digit,
        test_is_graph,
        test_is_lower,
        test_is_print,
        test_is_punct,
        test_is_space,
        test_is_upper,
        test_is_xdigit,
        test_wcwidth,
        test_wcswidth,
    ].run_test_driver
);
