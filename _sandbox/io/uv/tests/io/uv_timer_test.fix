module UvTimerTest;

import Minilib.Common.IORef;
import Minilib.IO.Uv;
import Minilib.Monad.IO;
import Minilib.Monad.Reader;
import Minilib.Monad.Error;
import Minilib.Testing.UnitTest;

//log_test: [m: MonadIO] String -> m () = |str| println("[TEST] " + str).lift_io;
log_test: [m: MonadIO] String -> m () = |str| pure();

test_timer_init: TestCase;
test_timer_init = (
    make_test("test_timer_init") $ |_|
    let loop = *UvLoop::make;
    let timer = *UvTimer::init(loop);
    loop.run_default;;
    pure()
);

test_timer_start: TestCase;
test_timer_start = (
    make_test("test_timer_start") $ |_|
    let res = *IORef::make(err("not done"): Result ErrMsg ());
    let loop = *UvLoop::make;
    let timer = *UvTimer::init(loop);
    let on_timer = |timer| (
        do {
            emprintln("on_timer");;
            timer.stop;;
            res.set(ok())
        }
        .try(|errmsg|
            // TODO: exit loop
            res.set(err(errmsg))
        )
    );
    timer.start(on_timer, 100, 0);;
    loop.run_default;;
    assert_equal("res", ok(), *res.get);;
    pure()
);

main: IO ();
main = (
    [
        test_timer_init,
        test_timer_start,
    ]
    .run_test_driver
);
