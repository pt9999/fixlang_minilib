module Main;

//import AsyncTask;
import Debug;

import Minilib.Crypto.Tls13.TLSSession;
import Minilib.Net.Tcp;
import Minilib.Monad.State;
import Minilib.Text.Hex;

https_fetch: () -> IOFail ();
https_fetch = |_| (
    let host_port = "localhost:443";
    let path = "/";
    let socket: Socket = *connect_to_tcp_server(host_port);
    let session: TLSSession = *TLSSession::make(socket);
    let sm: StateT TLSSession IOFail () = do {
        eval *send_client_hello("localhost");
        eval *recv_server_hello;
        eval *recv_server_params;
        //eval *send_appdata("GET / HTTP/1.1\n\n".get_bytes.pop_back);
        let appdata = *recv_appdata;
        eval debug_println("appdata=" + appdata.to_string_hex);
        pure()
    };
    sm.run_state_t(session).map(@0)
);

main: IO ();
main = do {
    https_fetch()
}.try(eprintln);
