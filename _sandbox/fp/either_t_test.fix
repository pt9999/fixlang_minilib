module Main;

import Minilib.Functor.EitherT;
import Minilib.Trait.Traversable;
import Minilib.Trait.Eq1;
import Minilib.Testing.UnitTest;

test_either_t_functor: TestCase;
test_either_t_functor = (
    make_test("test_either_t_functor") $ |_|
    let ea: EitherT Option Array I64 = left $ some(1);
    let ea = ea.map(to_string);
    assert_true("left", ea.eq1(left $ some("1")));;
    let ea: EitherT Option Array I64 = right $ [2];
    let ea = ea.map(to_string);
    assert_true("right", ea.eq1(right $ ["2"]));;
    pure()
);

test_either_t_eq: TestCase;
test_either_t_eq = (
    make_test("test_either_t_eq") $ |_|
    let o1: EitherT Option (Result ErrMsg) I64 = left $ some(1);
    let o2: EitherT Option (Result ErrMsg) I64 = left $ none();
    let r1: EitherT Option (Result ErrMsg) I64 = right $ ok(1);
    let r2: EitherT Option (Result ErrMsg) I64 = right $ err("e");
    assert_true("o1 == o1", o1.eq(o1));;
    assert_true("o1 != o2", ! o1.eq(o2));;
    assert_true("o1 != r1", ! o1.eq(r1));;
    assert_true("r1 == r1", r1.eq(r1));;
    assert_true("r1 != r2", ! r1.eq(r2));;
    assert_true("r1 != o1", ! r1.eq(o1));;
    // TODO: assert_equal を利用する ([EitherT f g a: ToString] が必要)
    pure()
);

test_either_t_eq1: TestCase;
test_either_t_eq1 = (
    make_test("test_either_t_eq1") $ |_|
    let o1: EitherT Option (Result ErrMsg) I64 = left $ some(1);
    let o2: EitherT Option (Result ErrMsg) I64 = left $ none();
    let r1: EitherT Option (Result ErrMsg) I64 = right $ ok(1);
    let r2: EitherT Option (Result ErrMsg) I64 = right $ err("e");
    assert_true("o1 == o1", o1.eq1(o1));;
    assert_true("o1 != o2", ! o1.eq1(o2));;
    assert_true("o1 != r1", ! o1.eq1(r1));;
    assert_true("r1 == r1", r1.eq1(r1));;
    assert_true("r1 != r2", ! r1.eq1(r2));;
    assert_true("r1 != o1", ! r1.eq1(o1));;
    pure()
);

test_either_t_traversable: TestCase;
test_either_t_traversable = (
    make_test("test_either_t_traversable") $ |_|
    let o1: EitherT Option (Result ErrMsg) (Array I64) = left $ some([1, 2]);
    let o2: EitherT Option (Result ErrMsg) (Array I64) = left $ none();
    let r1: EitherT Option (Result ErrMsg) (Array I64) = right $ ok([1, 2]);
    let r2: EitherT Option (Result ErrMsg) (Array I64) = right $ err("e");
    assert_true("o1", o1.sequence.eq([left $ some(1), left $ some(2)]));;
    assert_true("o2", o2.sequence.eq([left $ none()]));;
    assert_true("r1", r1.sequence.eq([right $ ok(1), right $ ok(2)]));;
    assert_true("r2", r2.sequence.eq([right $ err("e")]));;
    pure()
);

main: IO ();
main = (
    [
        test_either_t_functor,
        test_either_t_eq,
        test_either_t_eq1,
        test_either_t_traversable,
    ]
    .run_test_driver
);
