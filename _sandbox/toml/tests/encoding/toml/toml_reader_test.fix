module TomlReaderTest;

import Minilib.Encoding.Toml.TomlReader;
import Minilib.Text.SimpleParser;
import Minilib.Text.StringEx;
import Minilib.Testing.UnitTest;

test_parse_ws: TestCase;
test_parse_ws = (
    make_table_test("test_parse_ws",
        [
            ("", ok $ ""),
            ("abc", ok $ ""),
            ("  \t\t\nabc", ok $ "  \t\t"),
        ],
        |(input, expected)|
        assert_equal("eq", expected, parse_ws.map(_unsafe_to_string).eval_parser_str(input))
    )
);

test_parse_newline: TestCase;
test_parse_newline = (
    make_table_test("test_parse_newline",
        [
            ("", err $ _NotMatch),
            ("a\n", err $ _NotMatch),
            ("\n\n", ok $ "\n"),
            ("\r\n\n", ok $ "\r\n"),
        ],
        |(input, expected)|
        assert_equal("eq", expected, parse_newline.map(_unsafe_to_string).eval_parser_str(input))
    )
);

test_parse_comment: TestCase;
test_parse_comment = (
    make_table_test("test_parse_comment",
        [
            ("", err $ _NotMatch),
            ("#  \t\tabc ã‚ã„ã†\n", ok $ "#  \t\tabc ã‚ã„ã†"),
        ],
        |(input, expected)|
        assert_equal("eq", expected, parse_comment.map(_unsafe_to_string).eval_parser_str(input))
    )
);

// test_parse_keyval
// test_parse_key
// test_parse_simple_key

test_parse_unquoted_key: TestCase;
test_parse_unquoted_key = (
    make_table_test("test_parse_unquoted_key",
        [
            ("", err $ _NotMatch),
            ("-_  ", ok $ "-_"),
            ("AXZ--axz__059!?", ok $ "AXZ--axz__059"),
            ("123", ok $ "123"),
        ],
        |(input, expected)|
        assert_equal("eq", expected, parse_unquoted_key.map(_unsafe_to_string).eval_parser_str(input))
    )
);

test_parse_string: TestCase;
test_parse_string = (
    make_table_test("test_parse_string",
        [
            ("", err $ _NotMatch),
            ("\"\"", ok $ ""),
            ("\"abc\"", ok $ "abc"),
            ("\"\"\"abc\"\"\"", ok $ "abc"),
            ("'abc'", ok $ "abc"),
            ("'''abc'''", ok $ "abc"),
        ],
        |(input, expected)|
        assert_equal("eq", expected, parse_string.eval_parser_str(input))
    )
);

test_parse_basic_string: TestCase;
test_parse_basic_string = (
    make_table_test("test_parse_basic_string",
        [
            ("", err $ _NotMatch),
            ("\"abc", err $ _NotMatch),
            ("\"\"", ok $ ""),
            ("\"abc\"", ok $ "abc"),
            ("\"\\\"\\\\\\b\\e\\f\\n\\r\\t\"", ok $ "\"\\\u0008\u001b\u000c\u000a\u000d\u0009"),
            ("\"\\x41\"", ok $ "A"),
            ("\"\\u3042\"", ok $ "ã‚"),
            ("\"\\U0001F600\"", ok $ "ğŸ˜€"),
            ("\"\\x41\\u3042\\U0001F600\"", ok $ "Aã‚ğŸ˜€"),
            ("\"Aã‚ğŸ˜€\"", ok $ "Aã‚ğŸ˜€"),
        ],
        |(input, expected)|
        assert_equal("eq", expected, parse_basic_string.map(_unsafe_to_string).eval_parser_str(input))
    )
);

test_parse_ml_basic_string: TestCase;
test_parse_ml_basic_string = (
    make_table_test("test_parse_ml_basic_string",
        [
            ("", err $ _NotMatch),
            ("\"abc\"", err $ _NotMatch),
            ("\"\"\"\"\"\"", ok $ ""),
            ("\"\"\"abc\"\"\"", ok $ "abc"),
            ("\"\"\"\"abc\"\"\"\"", ok $ "\"abc\""),
            ("\"\"\"\"\"abc\"\"\"\"\"", ok $ "\"\"abc\"\""),
            ("\"\"\"\\\"\\\\\\b\\e\\f\\n\\r\\t\"\"\"", ok $ "\"\\\u0008\u001b\u000c\u000a\u000d\u0009"),
            ("\"\"\"\\x41\\u3042\\U0001F600Aã‚ğŸ˜€\"\"\"", ok $ "Aã‚ğŸ˜€Aã‚ğŸ˜€"),
            ("\"\"\"\nRoses are red\nViolets are blue\"\"\"", ok $ "Roses are red\nViolets are blue"),
            ("\"\"\"\r\nRoses are red\r\nViolets are blue\"\"\"", ok $ "Roses are red\r\nViolets are blue"),
            ("\"\"\"\nThe quick brown \\\n \n  \n  fox jumps over \\\n\tthe lazy dog.\"\"\"", ok $ "The quick brown fox jumps over the lazy dog."),
            ("\"\"\"\\\n       The quick brown \\\n       fox jumps over \\\n       the lazy dog.\\\n       \"\"\"", ok $ "The quick brown fox jumps over the lazy dog."),
            ("\"\"\"Here are two quotation marks: \"\". Simple enough.\"\"\"", ok $ "Here are two quotation marks: \"\". Simple enough."),
            ("\"\"\"Here are three quotation marks: \"\"\".\"\"\"", ok $ "Here are three quotation marks: "),   // .\"\"\" is remained
            ("\"\"\"Here are three quotation marks: \"\"\\\".\"\"\"", ok $ "Here are three quotation marks: \"\"\"."),
            ("\"\"\"\"This,\" she said, \"is just a pointless statement.\"\"\"\"", ok $ "\"This,\" she said, \"is just a pointless statement.\""),
        ],
        |(input, expected)|
        assert_equal("eq", expected, parse_ml_basic_string.map(_unsafe_to_string).eval_parser_str(input))
    )
);

test_parse_literal_string: TestCase;
test_parse_literal_string = (
    make_table_test("test_parse_literal_string",
        [
            ("", err $ _NotMatch),
            ("'abc", err $ _NotMatch),
            ("'abc'", ok $ "abc"),
            ("'\u0009 !\"#$%&()*+,-./012'", ok $ "\u0009 !\"#$%&()*+,-./012"),
            ("'[\\]^_`{|}~}'", ok $ "[\\]^_`{|}~}"),
            ("'Î±Ğ”ã‚ğŸ˜€'", ok $ "Î±Ğ”ã‚ğŸ˜€"),
            ("'C:\\Users\\nodejs\\templates'", ok $ "C:\\Users\\nodejs\\templates"),
            ("'\\\\ServerX\\admin$\\system32\\'", ok $ "\\\\ServerX\\admin$\\system32\\"),
            ("'Tom \"Dubs\" Preston-Werner'", ok $ "Tom \"Dubs\" Preston-Werner"),
            ("'<\\i\\c*\\s*>'", ok $ "<\\i\\c*\\s*>"),
        ],
        |(input, expected)|
        assert_equal("eq", expected, parse_literal_string.map(_unsafe_to_string).eval_parser_str(input))
    )
);

test_parse_ml_literal_string: TestCase;
test_parse_ml_literal_string = (
    make_table_test("test_parse_ml_literal_string",
        [
            ("", err $ _NotMatch),
            ("'abc'", err $ _NotMatch),
            ("''''''", ok $ ""),
            ("'''''''", ok $ "'"),
            ("''''''''", ok $ "''"),
            ("'''abc'''", ok $ "abc"),
            ("''''abc''''", ok $ "'abc'"),
            ("'''''abc'''''", ok $ "''abc''"),
            ("'''I [dw]on't need \\d{2} apples'''", ok $ "I [dw]on't need \\d{2} apples"),
            ("'''\nRoses are red\nViolets are blue'''", ok $ "Roses are red\nViolets are blue"),
            ("'''\r\nRoses are red\r\nViolets are blue'''", ok $ "Roses are red\r\nViolets are blue"),
            ("'''\n The quick brown\nfox jumps over\nthe lazy dog.\n'''", ok $ " The quick brown\nfox jumps over\nthe lazy dog.\n"),
            ("'''Here are two quotation marks: ''. Simple enough.'''", ok $ "Here are two quotation marks: ''. Simple enough."),
            ("''''That,' she said, 'is still pointless.''''", ok $ "'That,' she said, 'is still pointless.'"),
        ],
        |(input, expected)|
        assert_equal("eq", expected, parse_ml_literal_string.map(_unsafe_to_string).eval_parser_str(input))
    )
);

main: IO ();
main = (
    [
        test_parse_ws,
        test_parse_newline,
        test_parse_comment,
        test_parse_unquoted_key,
        test_parse_string,
        test_parse_basic_string,
        test_parse_ml_basic_string,
        test_parse_literal_string,
        test_parse_ml_literal_string,
    ]
    .run_test_driver
);